import{jsx as u,jsxs as k}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as $,classes as z}from"@dropins/tools/lib.js";import{g as V,c as F,u as O,F as R,B as K}from"./useInLineAlert.js";import{useState as g,useCallback as E,useEffect as Q,useMemo as tt}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{a as at}from"./getCustomerToken.js";import{r as rt}from"./resendConfirmationEmail.js";import{s as st,a as ot}from"./simplifyTransformAttributesForm.js";import{c as et}from"./confirmEmail.js";import{useText as W}from"@dropins/tools/i18n.js";import{Header as it,InLineAlert as nt,InputPassword as ct}from"@dropins/tools/components.js";import{E as mt}from"./EmailConfirmationForm.js";const ut=({emailConfirmationStatusMessage:t,translations:r,initialEmailValue:e,routeSignUp:l,routeForgotPassword:c,routeRedirectOnSignIn:_,onErrorCallback:w,setActiveComponent:a,onSuccessCallback:f,onSignUpLinkClick:h,handleSetInLineAlertProps:s,routeRedirectOnEmailConfirmationClose:b})=>{const[A,P]=g(""),[L,n]=g(!1),[C,d]=g(""),[x,y]=g(!1),[M,S]=g({userName:"",status:!1}),[B,I]=g(!1),[T,N]=g([]),p=E(async i=>{s(),n(!0),y(!1),N([]),await rt(i)},[s]),U=E(i=>{i.length?y(!1):y(!0),d(i)},[]);Q(()=>{t!=null&&t.text&&s({text:t.text,type:t.status?t.status:void 0})},[t,s]);const v=E(async i=>{var q;s(),I(!0);const m=V(i.target);if(m.password||(y(!0),I(!1)),m!=null&&m.email&&(m!=null&&m.password)){const{email:H,password:Y}=m,o=await at({email:H,password:Y,handleSetInLineAlertProps:s,onErrorCallback:w,translations:r});if((q=o==null?void 0:o.errorMessage)!=null&&q.length){P(H);const J=o.errorMessage.includes("This account isn't confirmed. Verify and try again."),Z=J?r.resendEmailInformationText:o.errorMessage;N(J?[{label:r.resendEmailButtonText,onClick:()=>{p(H)}}]:[]),s({text:Z,type:"error"}),d("")}o!=null&&o.userName&&(i.target.reset(),F(_)?window.location.href=_():(f==null||f({userName:o==null?void 0:o.userName,status:!0}),S({userName:o==null?void 0:o.userName,status:!0}))),y(!1)}I(!1)},[s,w,r,p,_,f]),j=E(()=>{if(F(a)){a("resetPasswordForm");return}F(c)&&(window.location.href=c())},[c,a]),D=E(()=>{if(F(h)&&h(),F(a)){a("signUpForm");return}F(l)&&(window.location.href=l())},[h,l,a]),G=tt(()=>{const i=st(ot);return e!=null&&e.length?i==null?void 0:i.map(m=>({...m,defaultValue:e})):i},[e]),X=E(()=>{s(),F(b)?window.location.href=b():n(!1)},[s,b]);return{additionalActionsAlert:T,userEmail:A,defaultEnhancedEmailFields:G,passwordError:x,isSuccessful:M,isLoading:B,signInPasswordValue:C,showEmailConfirmationForm:L,setShowEmailConfirmationForm:n,setSignInPasswordValue:d,submitLogInUser:v,forgotPasswordCallback:j,onSignUpLinkClickCallback:D,handledOnPrimaryButtonClick:X,handleSetPassword:U}},ft=()=>{let t=new URL(window.location.href),r=t.searchParams.get("email"),e=t.searchParams.get("key");r&&e&&(t.searchParams.delete("email"),t.searchParams.delete("key"),window.history.replaceState({},document.title,t.toString()))},dt=({enableEmailConfirmation:t})=>{const r=W({accountConfirmMessage:"Auth.EmailConfirmationForm.accountConfirmMessage",accountConfirmationEmailSuccessMessage:"Auth.EmailConfirmationForm.accountConfirmationEmailSuccessMessage"}),[e,l]=g({text:"",status:""});return Q(()=>{if(t){const{search:c}=window.location;c.includes("email=")&&c.includes("key=")&&(async()=>{var f,h,s;const w=new URLSearchParams(c),a=await et({customerEmail:w.get("email"),customerConfirmationKey:w.get("key")});if(!a)return null;(f=a==null?void 0:a.errors)!=null&&f.length?l({text:a==null?void 0:a.errors[0].message,status:"error"}):(l({text:a.data.confirmEmail.customer.email?r.accountConfirmationEmailSuccessMessage.replace("{email}",(s=(h=a==null?void 0:a.data)==null?void 0:h.confirmEmail.customer)==null?void 0:s.email):r.accountConfirmMessage,status:"success"}),ft())})()}},[t,r]),{emailConfirmationStatusMessage:e}},pt=({slots:t,labels:r,formSize:e="default",initialEmailValue:l="",renderSignUpLink:c=!1,enableEmailConfirmation:_=!1,hideCloseBtnOnEmailConfirmation:w=!1,routeRedirectOnEmailConfirmationClose:a,routeRedirectOnSignIn:f,routeForgotPassword:h,routeSignUp:s,onSuccessCallback:b,setActiveComponent:A,onErrorCallback:P,onSignUpLinkClick:L})=>{const n=W({title:"Auth.SignInForm.title",buttonPrimary:"Auth.SignInForm.buttonPrimary",buttonSecondary:"Auth.SignInForm.buttonSecondary",buttonTertiary:"Auth.SignInForm.buttonTertiary",resendEmailInformationText:"Auth.Notification.resendEmailNotification.informationText",resendEmailButtonText:"Auth.Notification.resendEmailNotification.buttonText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel"}),{emailConfirmationStatusMessage:C}=dt({enableEmailConfirmation:_}),{inLineAlertProps:d,handleSetInLineAlertProps:x}=O(),{userEmail:y,additionalActionsAlert:M,defaultEnhancedEmailFields:S,passwordError:B,isSuccessful:I,isLoading:T,signInPasswordValue:N,showEmailConfirmationForm:p,submitLogInUser:U,forgotPasswordCallback:v,onSignUpLinkClickCallback:j,handledOnPrimaryButtonClick:D,handleSetPassword:G}=ut({translations:n,emailConfirmationStatusMessage:C,initialEmailValue:l,routeSignUp:s,routeForgotPassword:h,routeRedirectOnSignIn:f,setActiveComponent:A,onErrorCallback:P,onSuccessCallback:b,onSignUpLinkClick:L,handleSetInLineAlertProps:x,routeRedirectOnEmailConfirmationClose:a});return I.status&&(t!=null&&t.SuccessNotification)?u($,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:t==null?void 0:t.SuccessNotification,context:{isSuccessful:I}}):p?u(mt,{formSize:e,userEmail:y,inLineAlertProps:d,hideCloseBtnOnEmailConfirmation:w,handleSetInLineAlertProps:x,onPrimaryButtonClick:D}):k("div",{className:z(["auth-signInForm",e]),"data-testid":"signInForm",children:[u(it,{title:(r==null?void 0:r.formTitleText)??n.title,divider:!1,className:"auth-signInForm__title"}),d.text?u(nt,{"data-testid":"authInLineAlert",className:"auth-signInForm__notification",type:d.type,variant:"secondary",heading:d.text,icon:d.icon,additionalActions:M}):null,k(R,{name:"signIn_form",className:"auth-signInForm__form",submitCallback:U,isLoading:T,fieldsConfig:S,children:[u(ct,{hideStatusIndicator:!0,className:"auth-signInForm__form__password",autoComplete:"current-password",error:B,defaultValue:N,onValue:G,placeholder:n.placeholder,floatingLabel:n.floatingLabel}),k("div",{className:"auth-signInForm__form__buttons",children:[k("div",{className:"auth-signInForm__form__buttons--combine",children:[u(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonTertiary,className:"auth-signInForm__button auth-signInForm__button--forgot",enableLoader:!1,onClick:v,"data-testid":"switchToSignUp"}),c?u("span",{}):null,c?u(K,{type:"button",variant:"tertiary",style:{padding:0},buttonText:n.buttonSecondary,className:"auth-signInForm__button auth-signInForm__button--signup",enableLoader:!1,onClick:j}):null]}),u(K,{type:"submit",buttonText:(r==null?void 0:r.primaryButtonText)??n.buttonPrimary,variant:"primary",className:"auth-signInForm__button auth-signInForm__button--submit",enableLoader:T})]})]}),u("div",{id:"generateCustomerToken"})]})};export{pt as S};

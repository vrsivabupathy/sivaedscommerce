/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as m,jsxs as K}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as Pe,classes as _e}from"@dropins/tools/lib.js";import"@dropins/tools/event-bus.js";import"@dropins/tools/recaptcha.js";import{g as Ne,c as Ee,a as Ue}from"./createCustomerAddress.js";import{useState as p,useEffect as ye,useCallback as T,useMemo as Le}from"@dropins/tools/preact-hooks.js";import{s as ue,b as Me}from"./simplifyTransformAttributesForm.js";import{v as Te,u as xe,a as Se}from"./usePasswordValidationMessage.js";import{a as ve}from"./getCustomerToken.js";import{p as de,E as ce}from"./getStoreConfig.js";import{c as V,g as qe,u as Ce,F as Ae,B as le}from"./UpdatePasswordForm.js";import{c as Be}from"./transform-attributes-form.js";import{Header as Ke,InLineAlert as je,InputPassword as fe,Field as re,Checkbox as te}from"@dropins/tools/components.js";/* empty css                       */import{S as Ie}from"./SkeletonLoader.js";import{E as Ge}from"./EmailConfirmationForm.js";import{useText as He}from"@dropins/tools/i18n.js";const he=(u,r)=>r!=null&&r.length?u.map(e=>{var d;const t=(d=r.find(({code:n})=>n===e.code))==null?void 0:d.defaultValue;return t?{...e,defaultValue:t}:e}):u,Ve=({inputsDefaultValueSet:u,fieldsConfigForApiVersion1:r,apiVersion2:e})=>{const[t,d]=p([]);return ye(()=>{(async()=>{if(e){const s=await Ne("customer_account_create");if(s!=null&&s.length)if(u!=null&&u.length){const w=he(s,u);d(w)}else d(s)}else{const s=ue(Me),w=ue(r),E=he(s,u);d(r&&r.length?w:E)}})()},[e,r,u]),{fieldsListConfigs:t}},We=(u,r)=>{const e=["date_of_birth","email","firstname","gender","is_subscribed","lastname","middlename","password","prefix","suffix","taxvat"],t=Be(u,"snakeCase",{firstName:"firstname",lastName:"lastname"});if(!r)return{...t,...t!=null&&t.gender?{gender:Number(t==null?void 0:t.gender)}:{}};const d={},n=[];return Object.keys(t).forEach(s=>{e.includes(s)?d[s]=s.includes("gender")?Number(t[s]):t[s]:n.push({attribute_code:s,value:t[s]})}),n.length>0&&(d.custom_attributes=n),d},$e=({requireRetypePassword:u,addressesData:r,translations:e,isEmailConfirmationRequired:t,apiVersion2:d=!0,passwordConfigs:n,isAutoSignInEnabled:s,routeRedirectOnSignIn:w,routeSignIn:E,onErrorCallback:x,onSuccessCallback:h,setActiveComponent:b,handleSetInLineAlertProps:P,routeRedirectOnEmailConfirmationClose:S})=>{const[W,v]=p(!1),[o,a]=p(""),[g,c]=p(""),[j,U]=p(""),[I,q]=p(!1),[$,C]=p({userName:"",status:!1}),[l,A]=p(""),[J,G]=p(!1),[O,y]=p(!1),[H,Q]=p(!0),X=T(i=>{const f=i.target.value;v(!f.length),f.length&&o.length&&f!==o&&c(e.passwordMismatch)},[o,e.passwordMismatch]),Y=T(i=>{const f=i.target.value;c(f.length?"":e.requiredFieldError),f.length&&l.length&&f!==l&&c(e.passwordMismatch)},[l,e.passwordMismatch,e.requiredFieldError]),Z=T(i=>{a(i),c(i?l===i?"":e.passwordMismatch:e.requiredFieldError)},[e,l]),k=T(({target:i})=>{Q(i.checked)},[]),z=T(()=>{if(V(b)){b("signInForm");return}V(E)&&(window.location.href=E())},[b,E]),D=T(i=>{A(i),v(!i.length),i===o&&c("")},[o]),R=T(()=>{P(),A(""),V(S)?window.location.href=S():(q(!1),b==null||b("signInForm"))},[P,S,b]),L=()=>{G(!0),y(!1)},_=()=>{const i=l.length&&o.length,f=l!==o;L(),v(!l.length),o||c(e.requiredFieldError),i&&f&&c(e.passwordMismatch)};return{showPasswordErrorMessage:W,confirmPassword:o,confirmPasswordMessage:g,isKeepMeLogged:H,userEmail:j,showEmailConfirmationForm:I,isSuccessful:$,isClickSubmit:J,signUpPasswordValue:l,isLoading:O,onSubmitSignUp:async(i,f)=>{var oe,ae,me;if(P(),c(""),y(!0),!f){_();return}if(u&&(g.length||l!==o)){L(),c(o.length?e.passwordMismatch:e.requiredFieldError);return}const{confirmPasswordField:Je,...ie}=qe(i.target),{email:ee,password:B,is_subscribed:ge}=ie,pe=(n==null?void 0:n.requiredCharacterClasses)||0,Fe=(n==null?void 0:n.minLength)||1;if(!Te(B,pe)||Fe>(B==null?void 0:B.length)){L();return}const we=We({...ie,is_subscribed:!!ge||!1},d),F=await Ee(we,d);if((oe=F==null?void 0:F.errors)!=null&&oe.length){const{errors:M}=F;P==null||P({type:"error",text:(ae=M[0])==null?void 0:ae.message}),x==null||x(M),de(ce.CREATE_ACCOUNT_EVENT,{updateProfile:!1}),U(ee)}else{const M=F==null?void 0:F.firstName;if(de(ce.CREATE_ACCOUNT_EVENT,{email:F==null?void 0:F.email,updateProfile:!0}),t||!s){if(h==null||h({userName:M,status:!0}),t){(me=i.target)==null||me.reset(),A(""),q(!0),U(ee),y(!1);return}if(!s){y(!1),C({userName:M,status:!0});return}}const N=await ve({email:ee,password:B,translations:e,handleSetInLineAlertProps:P,onErrorCallback:x});if(N!=null&&N.userName){if(r!=null&&r.length)for(const ne of r)try{await Ue(ne)}catch(be){console.error(e.failedCreateCustomerAddress,ne,be)}V(w)?window.location.href=w():(h==null||h({userName:N==null?void 0:N.userName,status:!0}),C({userName:N==null?void 0:N.userName,status:!0}))}else h==null||h({userName:M,status:!0}),C({userName:M,status:!0})}y(!1)},signInButton:z,handleSetSignUpPasswordValue:D,onKeepMeLoggedChange:k,handleHideEmailConfirmationForm:R,handleConfirmPasswordChange:Z,onBlurPassword:X,onBlurConfirmPassword:Y}},nr=({requireRetypePassword:u=!1,addressesData:r,formSize:e="default",inputsDefaultValueSet:t,fieldsConfigForApiVersion1:d,apiVersion2:n=!0,isAutoSignInEnabled:s=!0,displayTermsOfUseCheckbox:w=!1,displayNewsletterCheckbox:E=!1,hideCloseBtnOnEmailConfirmation:x=!1,routeRedirectOnEmailConfirmationClose:h,routeRedirectOnSignIn:b,routeSignIn:P,onErrorCallback:S,onSuccessCallback:W,setActiveComponent:v,slots:o})=>{const a=He({title:"Auth.SignUpForm.title",buttonPrimary:"Auth.SignUpForm.buttonPrimary",buttonSecondary:"Auth.SignUpForm.buttonSecondary",privacyPolicyDefaultText:"Auth.SignUpForm.privacyPolicyDefaultText",subscribedDefaultText:"Auth.SignUpForm.subscribedDefaultText",keepMeLoggedText:"Auth.SignUpForm.keepMeLoggedText",customerTokenErrorMessage:"Auth.Api.customerTokenErrorMessage",failedCreateCustomerAddress:"Auth.SignUpForm.failedCreateCustomerAddress",placeholder:"Auth.InputPassword.placeholder",floatingLabel:"Auth.InputPassword.floatingLabel",requiredFieldError:"Auth.FormText.requiredFieldError",confirmPasswordPlaceholder:"Auth.SignUpForm.confirmPassword.placeholder",confirmPasswordFloatingLabel:"Auth.SignUpForm.confirmPassword.floatingLabel",passwordMismatch:"Auth.SignUpForm.confirmPassword.passwordMismatch"}),{passwordConfigs:g,isEmailConfirmationRequired:c}=xe(),{fieldsListConfigs:j}=Ve({fieldsConfigForApiVersion1:d,apiVersion2:n,inputsDefaultValueSet:t}),{inLineAlertProps:U,handleSetInLineAlertProps:I}=Ce(),{showPasswordErrorMessage:q,confirmPassword:$,confirmPasswordMessage:C,isKeepMeLogged:l,userEmail:A,showEmailConfirmationForm:J,isSuccessful:G,isClickSubmit:O,signUpPasswordValue:y,isLoading:H,onSubmitSignUp:Q,signInButton:X,handleSetSignUpPasswordValue:Y,onKeepMeLoggedChange:Z,handleHideEmailConfirmationForm:k,handleConfirmPasswordChange:z,onBlurPassword:D,onBlurConfirmPassword:R}=$e({requireRetypePassword:u,addressesData:r,translations:a,isEmailConfirmationRequired:c,apiVersion2:n,passwordConfigs:g,isAutoSignInEnabled:s,routeRedirectOnSignIn:b,routeSignIn:P,onErrorCallback:S,onSuccessCallback:W,setActiveComponent:v,handleSetInLineAlertProps:I,routeRedirectOnEmailConfirmationClose:h}),{isValidUniqueSymbols:L,defaultLengthMessage:_}=Se({password:y,isClickSubmit:O,passwordConfigs:g}),se=Le(()=>q?a.requiredFieldError:L==="error"||(_==null?void 0:_.status)==="error"?" ":"",[_==null?void 0:_.status,L,q,a.requiredFieldError]),i=!c&&(r==null?void 0:r.length);return!j.length&&n?m("div",{className:`auth-sign-up-form auth-sign-up-form--${e} skeleton-loader`,"data-testid":"SignUpForm",children:m(Ie,{activeSkeleton:"signUpForm"})}):G.status&&(o!=null&&o.SuccessNotification)?m(Pe,{"data-testid":"successNotificationTestId",name:"SuccessNotification",slot:o==null?void 0:o.SuccessNotification,context:{isSuccessful:G}}):J?m(Ge,{formSize:e,userEmail:A,inLineAlertProps:U,hideCloseBtnOnEmailConfirmation:x,handleSetInLineAlertProps:I,onPrimaryButtonClick:k}):K("div",{className:_e(["auth-sign-up-form",`auth-sign-up-form--${e}`]),"data-testid":"SignUpForm",children:[m(Ke,{title:a.title,divider:!1,className:"auth-sign-up-form__title"}),U.text?m(je,{className:"auth-sign-up-form__notification",type:U.type,variant:"secondary",heading:U.text,icon:U.icon}):null,K(Ae,{onSubmit:Q,className:"auth-sign-up-form__form",loading:H,name:"signUp_form",fieldsConfig:j,children:[K(fe,{validateLengthConfig:_,className:"auth-sign-up-form__form__field",autoComplete:"current-password",name:"password",minLength:g==null?void 0:g.minLength,errorMessage:se,defaultValue:y,uniqueSymbolsStatus:L,requiredCharacterClasses:g==null?void 0:g.requiredCharacterClasses,onValue:Y,placeholder:a.placeholder,floatingLabel:a.floatingLabel,onBlur:D,children:[u?m("div",{className:"auth-sign-up-form__form__confirm-wrapper",children:m(fe,{className:"auth-sign-up-form__form__field auth-sign-up-form__form__field--confirm-password",autoComplete:"confirmPassword",name:"confirmPasswordField",placeholder:a.confirmPasswordPlaceholder,floatingLabel:a.confirmPasswordFloatingLabel,errorMessage:C,defaultValue:$,onValue:z,onBlur:R})}):null,i?m("div",{className:"auth-sign-up-form__automatic-login","data-testid":"automaticLogin",children:m(re,{children:m(te,{name:"",placeholder:a.keepMeLoggedText,label:a.keepMeLoggedText,checked:l,onChange:Z})})}):null]}),E||w?K("div",{className:"auth-sign-up-form__item auth-sign-up-form__checkbox",children:[E?m(re,{children:m(te,{"data-testid":"isSubscribed",name:"is_subscribed",placeholder:a.subscribedDefaultText,label:a.subscribedDefaultText})}):null,w?m(re,{children:m(te,{"data-testid":"privacyPolicy",name:"privacyPolicy",placeholder:a.privacyPolicyDefaultText,label:a.privacyPolicyDefaultText})}):null]}):null,K("div",{className:"auth-sign-up-form-buttons",children:[m(le,{type:"button",variant:"tertiary",style:{padding:0},buttonText:a.buttonSecondary,enableLoader:!1,onClick:X}),m(le,{type:"submit",buttonText:a.buttonPrimary,variant:"primary",enableLoader:H})]})]}),m("div",{id:"createCustomerV2"})]})};export{nr as S};

/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as r,jsxs as x}from"@dropins/tools/preact-jsx-runtime.js";import{classes as A,Slot as q}from"@dropins/tools/lib.js";import{Icon as B,Checkbox as P,Button as Q,CartItem as H,Image as $,Header as W,InLineAlert as j}from"@dropins/tools/components.js";import{u as V,a as Z}from"../chunks/OrderCancel.js";import{useState as v,useRef as D,useEffect as T,useCallback as F}from"@dropins/tools/preact-hooks.js";import{events as z}from"@dropins/tools/event-bus.js";import{s as U}from"../chunks/setTaxStatus.js";import{createRef as G,Fragment as J}from"@dropins/tools/preact.js";import{s as K,p as X,r as Y,m as I}from"../chunks/returnOrdersHelper.js";import{g as ee,r as te}from"../chunks/requestReturn.js";import{g as ne}from"../chunks/getStoreConfig.js";import*as R from"@dropins/tools/preact-compat.js";import{S as re,C as se}from"../chunks/CartSummaryItem.js";import{a as ae}from"../chunks/OrderLoaders.js";import{useText as ie}from"@dropins/tools/i18n.js";import"../chunks/getFormValues.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/transform-attributes-form.js";import"../chunks/convertCase.js";const ce=s=>R.createElement("svg",{id:"Icon_Warning_Base",width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},R.createElement("g",{clipPath:"url(#clip0_841_1324)"},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M11.9949 2.30237L0.802734 21.6977H23.1977L11.9949 2.30237Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M12.4336 10.5504L12.3373 14.4766H11.6632L11.5669 10.5504V9.51273H12.4336V10.5504ZM11.5883 18.2636V17.2687H12.4229V18.2636H11.5883Z",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round"})),R.createElement("defs",null,R.createElement("clipPath",{id:"clip0_841_1324"},R.createElement("rect",{width:24,height:21,fill:"white",transform:"translate(0 1.5)"})))),ue=s=>R.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...s},R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M0.75 12C0.75 5.78421 5.78421 0.75 12 0.75C18.2158 0.75 23.25 5.78421 23.25 12C23.25 18.2158 18.2158 23.25 12 23.25C5.78421 23.25 0.75 18.2158 0.75 12Z",stroke:"currentColor"}),R.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M6.75 12.762L10.2385 15.75L17.25 9",stroke:"currentColor"})),oe=({onSuccess:s,onError:a,handleSetInLineAlert:i,orderData:h})=>{const[m,l]=v({id:"",email:"",...h}),[L,g]=v("products"),[_,f]=v(!0),[c,b]=v([]),[k,y]=v([]),[t,C]=v({taxIncluded:!1,taxExcluded:!1}),[e,u]=v([]),p=D([]);p.current.length!==c.length&&(p.current=c.map((n,o)=>p.current[o]||G())),T(()=>{const n=z.on("order/data",o=>{l(o);const O=K(o);u(O),f(!1)},{eager:!0});return()=>{n==null||n.off()}},[]),T(()=>{ne().then(n=>{if(!n)return;const o=U(n==null?void 0:n.shoppingCartDisplayPrice);C(o)})},[]),T(()=>{ee("RMA_ITEM").then(n=>{n!=null&&n.length&&(y(n),f(!1))})},[]);const E=F(n=>{b(o=>o.findIndex(d=>(d==null?void 0:d.productSku)===(n==null?void 0:n.productSku))>-1?o.filter(d=>(d==null?void 0:d.productSku)!==(n==null?void 0:n.productSku)):[...o,n])},[]),S=F(n=>{g(n),i(),n==="products"&&b([])},[i]),N=F((n,o)=>{const O=c.map(d=>d.productSku===o?{...d,currentReturnOrderQuantity:n}:d);b(O)},[c]),w=F(async(n,o)=>{if(!o)return;f(!0);const O={orderUid:m.id,contactEmail:m.email},d=X(p);te({...O,items:d}).then(M=>{s==null||s(M),S("success"),i()}).catch(M=>{a==null||a(M.message),i({type:"error",heading:M.message})}),f(!1)},[S,a,s,i,m]);return{order:m,steps:L,loading:_,formsRef:p,taxConfig:t,attributesList:k,selectedProductList:c,itemsEligibleForReturn:e,handleSelectedProductList:E,handleSetQuantity:N,handleChangeStep:S,onSubmit:w}},le={success:ue,warning:ce,error:re},de=()=>{const[s,a]=v({type:"success",heading:""}),i=F(h=>{if(!(h!=null&&h.type)){a({type:"success",heading:""});return}const m=r(B,{source:le[h.type]});a({...h,icon:m})},[]);return{inLineAlertProps:s,handleSetInLineAlert:i}},pe=({itemsEligibleForReturn:s,slots:a,loading:i,taxConfig:h,translations:m,selectedProductList:l,handleSelectedProductList:L,showConfigurableOptions:g,handleSetQuantity:_,handleChangeStep:f})=>x("ul",{className:"order-return-order-product-list",children:[s==null?void 0:s.map((c,b)=>{const{quantityReturnRequested:k,quantityShipped:y,eligibleForReturn:t}=c,C=l.some(p=>(p==null?void 0:p.productSku)===c.productSku&&c.eligibleForReturn),e=y===k&&t,u=y-k===0?k:y-k;return x("li",{className:A(["order-return-order-product-list__item",["order-return-order-product-list__item--blur",e]]),children:[r(P,{"data-testid":`key_${b}`,name:`key_${b}`,checked:C,disabled:e,onChange:()=>{L({...c,currentReturnOrderQuantity:1})}}),r(se,{loading:i,product:{...c,totalQuantity:u},itemType:"",taxConfig:h,translations:m,showConfigurableOptions:g,disabledIncrementer:!C,onQuantity:u>1?p=>{_(p,c.productSku)}:void 0}),r(q,{"data-testid":"returnOrderItem",name:"ReturnOrderItem",slot:a==null?void 0:a.ReturnOrderItem})]},c.id)}),r("li",{className:"order-return-order-product-list__item",children:r(Q,{type:"button",onClick:()=>f("attributes"),disabled:!l.length,children:m.nextStep})})]}),he=({routeReturnSuccess:s,translations:a,orderData:i})=>x("div",{className:"order-return-order-message",children:[r("p",{className:"order-return-order-message__title",children:a.successTitle}),r("p",{className:"order-return-order-message__subtitle",children:a.successMessage}),r(Q,{href:(s==null?void 0:s(i))??"#",children:a.backStore})]}),me=({slots:s,formsRef:a,selectedProductList:i,loading:h,fieldsConfig:m,translations:l,handleChangeStep:L,onSubmit:g})=>{const{formData:_,errors:f,formRef:c,handleChange:b,handleBlur:k,handleSubmit:y}=V({fieldsConfig:Y(m,i==null?void 0:i.length),onSubmit:g});return x("form",{className:"order-return-reason-form",ref:c,onSubmit:y,name:"returnReasonForm",children:[i.map((t,C)=>{var w,n,o,O,d;const e=t==null?void 0:t.giftCard,u=t==null?void 0:t.product,p=I(m,C),E=`${t==null?void 0:t.id}_${C}`,S=(t==null?void 0:t.currentReturnOrderQuantity)??1,N={...t!=null&&t.currentReturnOrderQuantity?{[l.configurationsListQuantity]:S}:{},...t.configurableOptions||{},...t.bundleOptions||{},...e!=null&&e.senderName?{[l.sender]:e==null?void 0:e.senderName}:{},...e!=null&&e.senderEmail?{[l.sender]:e==null?void 0:e.senderEmail}:{},...e!=null&&e.recipientName?{[l.recipient]:e==null?void 0:e.recipientName}:{},...e!=null&&e.recipientEmail?{[l.recipient]:e==null?void 0:e.recipientEmail}:{},...e!=null&&e.message?{[l.message]:e==null?void 0:e.message}:{},...t!=null&&t.downloadableLinks?{[`${(w=t==null?void 0:t.downloadableLinks)==null?void 0:w.count} ${l.downloadableCount}`]:(n=t==null?void 0:t.downloadableLinks)==null?void 0:n.result}:{}};return x(J,{children:[r(H,{loading:h,title:r("div",{"data-testid":"product-name",children:(o=t==null?void 0:t.product)==null?void 0:o.name}),sku:r("div",{children:u==null?void 0:u.sku}),image:r($,{src:((O=u==null?void 0:u.thumbnail)==null?void 0:O.url)??"",alt:((d=u==null?void 0:u.thumbnail)==null?void 0:d.label)??"",loading:"lazy",width:"90",height:"120"}),configurations:N}),r("form",{name:E,ref:a==null?void 0:a.current[C],"data-quantity":S,children:r(Z,{className:"className",loading:h,fields:p,onChange:b,onBlur:k,errors:f,values:_})})]},t.id)}),r(q,{"data-testid":"returnFormActions",name:"ReturnFormActions",slot:s==null?void 0:s.ReturnFormActions,context:{handleChangeStep:L},children:x("div",{className:"order-return-reason-form__actions",children:[r(Q,{variant:"secondary",type:"button",onClick:()=>{L("products")},children:l.backStep}),r(Q,{children:l.submit})]})})]})},Ae=({className:s,orderData:a,slots:i,onSuccess:h,onError:m,routeReturnSuccess:l,showConfigurableOptions:L})=>{const g=ie({headerText:"Order.CreateReturn.headerText",successTitle:"Order.CreateReturn.success.title",successMessage:"Order.CreateReturn.success.message",sender:"Order.CreateReturn.giftCard.sender",recipient:"Order.CreateReturn.giftCard.recipient",message:"Order.CreateReturn.giftCard.message",outOfStock:"Order.CreateReturn.stockStatus.outOfStock",nextStep:"Order.CreateReturn.buttons.nextStep",backStep:"Order.CreateReturn.buttons.backStep",submit:"Order.CreateReturn.buttons.submit",backStore:"Order.CreateReturn.buttons.backStore",downloadableCount:"Order.CreateReturn.downloadableCount",returnedItems:"Order.CreateReturn.returnedItems",configurationsListQuantity:"Order.CreateReturn.configurationsList.quantity"}),{inLineAlertProps:_,handleSetInLineAlert:f}=de(),{order:c,itemsEligibleForReturn:b,formsRef:k,taxConfig:y,attributesList:t,steps:C,loading:e,selectedProductList:u,handleSelectedProductList:p,handleSetQuantity:E,handleChangeStep:S,onSubmit:N}=oe({orderData:a,onSuccess:h,onError:m,handleSetInLineAlert:f});if(e)return r("div",{children:r(ae,{})});if(!e&&!t.length)return r("div",{});const w={products:r(pe,{itemsEligibleForReturn:b,slots:i,translations:g,loading:e,taxConfig:y,selectedProductList:u,handleSelectedProductList:p,showConfigurableOptions:L,handleSetQuantity:E,handleChangeStep:S}),attributes:r(me,{slots:i,formsRef:k,loading:e,fieldsConfig:t,selectedProductList:u,handleChangeStep:S,translations:g,onSubmit:N}),success:r(he,{translations:g,routeReturnSuccess:l,orderData:c}),error:null};return x("div",{className:A(["order-create-return",s]),children:[r(W,{title:g.headerText}),_.heading?r(j,{className:"order-create-return_notification",variant:"secondary","data-testid":"orderCreateReturnNotification",..._}):null,w[C]]})};export{Ae as CreateReturn,Ae as default};

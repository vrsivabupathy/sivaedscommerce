/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as i,jsxs as y,Fragment as I}from"@dropins/tools/preact-jsx-runtime.js";import{Card as x,Header as M,Button as E,InLineAlert as L}from"@dropins/tools/components.js";import"../chunks/OrderCancelReasonsForm.js";import{u as $}from"../chunks/ReturnOrder.js";import{f as U}from"../chunks/returnOrdersHelper.js";import{classes as R,Slot as K}from"@dropins/tools/lib.js";import{f as T}from"../chunks/formatDateToLocale.js";import{useMemo as F,useState as P}from"@dropins/tools/preact-compat.js";import{r as G}from"../chunks/redirectTo.js";import{useText as O,Text as H}from"@dropins/tools/i18n.js";import{useState as A,useEffect as w}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/preact.js";import{events as v}from"@dropins/tools/event-bus.js";import{C as V}from"../chunks/OrderLoaders.js";import{G as W}from"../chunks/getGuestOrder.graphql.js";import{f as b,h as j}from"../chunks/fetch-graphql.js";import{t as k}from"../chunks/transform-order-details.js";import{u as q}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/convertCase.js";import"../chunks/getStoreConfig.js";const _={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested"},B=({slots:r,title:t,status:s,orderData:e,routeCreateReturn:d})=>{var N;const o=$(),n=String(s).toLocaleLowerCase(),c=(N=e==null?void 0:e.returns)==null?void 0:N[0],u=(c==null?void 0:c.returnStatus)??"",m=(c==null?void 0:c.createdReturnAt)??"",p=O(`Order.OrderStatusContent.${_[n]}.title`),f=O(`Order.OrderStatusContent.${_[n]}.message`),C=O(`Order.OrderStatusContent.${_[n]}.messageWithoutDate`),a=O({title:`Order.OrderStatusContent.resturnStatus.${U(u)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!s)return i("div",{});const l=e!=null&&e.orderStatusChangeDate?f==null?void 0:f.message.replace("{DATE}",e==null?void 0:e.orderStatusChangeDate):C.messageWithoutDate,S=(a==null?void 0:a.returnMessage.replace("{ORDER_CREATE_DATE}",T(e==null?void 0:e.orderDate)).replace("{RETURN_CREATE_DATE}",T(m)))??"",g=o?a.title:t??p.title;return y(x,{className:"order-order-status-content",variant:"secondary",children:[i(M,{title:g}),y("div",{className:"order-order-status-content__wrapper",children:[i("div",{className:R(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(r!=null&&r.OrderActions)]]),children:i("p",{children:o?S:l})}),i(Q,{orderData:e,slots:r,routeCreateReturn:d})]})]})};var h=(r=>(r.CANCEL="CANCEL",r.RETURN="RETURN",r.REORDER="REORDER",r))(h||{});const Q=({className:r,orderData:t,slots:s,routeCreateReturn:e})=>{const d=O({cancel:"Order.OrderStatusContent.actions.cancel",reorder:"Order.OrderStatusContent.actions.reorder"}),o=F(()=>{const n=t==null?void 0:t.availableActions,c=!!(n!=null&&n.length),u=()=>{G(e,{},t==null?void 0:t.returns[0])};return i(I,{children:s!=null&&s.OrderActions?i(K,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:s==null?void 0:s.OrderActions,context:t}):i("div",{"data-testid":"availableActionsList",className:R(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!c]]),children:n==null?void 0:n.map(m=>{var p;switch(m){case h.CANCEL:return i(E,{variant:"secondary",children:d.cancel});case h.RETURN:return i(E,{variant:"secondary",onClick:u,children:i(H,{id:"Order.OrderStatusContent.actions.return",plural:(p=t==null?void 0:t.returns)==null?void 0:p.length})});case h.REORDER:return i(E,{variant:"secondary",children:d.reorder})}})})})},[t,e,s==null?void 0:s.OrderActions,d]);return i("div",{className:R(["order-order-actions",r]),children:o})},z=({orderData:r})=>{const[t,s]=A(r),[e,d]=A(r==null?void 0:r.status);return w(()=>{const o=v.on("order/data",n=>{s(n),d(n.status)},{eager:!0});return()=>{o==null||o.off()}},[]),{orderStatus:e,order:t}},J=`
  mutation CONFIRM_CANCEL_ORDER_MUTATION(
      $orderId: ID!,
      $confirmationKey: String!
    ) {
    confirmCancelOrder(input: {
      order_id: $orderId,
      confirmation_key: $confirmationKey
    }) {
      order {
        ...guestOrderData
      }
      errorV2 {
        message
        code
      }
    }
  }
${W}
`,X=async(r,t)=>b(J,{variables:{orderId:r,confirmationKey:t}}).then(async({errors:s,data:e})=>{var n,c,u,m;const d=[...(n=e==null?void 0:e.confirmCancelOrder)!=null&&n.errorV2?[(c=e==null?void 0:e.confirmCancelOrder)==null?void 0:c.errorV2]:[],...s??[]];let o=null;return(u=e==null?void 0:e.confirmCancelOrder)!=null&&u.order&&(o=k((m=e==null?void 0:e.confirmCancelOrder)==null?void 0:m.order),v.emit("order/data",o)),d.length>0?j(d):o}),Y=({enableOrderCancellation:r})=>{const t=O({orderCancelled:"Order.OrderStatusContent.orderCanceled.message"}),[s,e]=A({text:"",status:void 0});return w(()=>{if(!r)return;const d=new URLSearchParams(window.location.search),o=d.get("orderId"),n=d.get("confirmationKey");o&&n&&X(atob(o),n).then(()=>{e({text:t.orderCancelled,status:"success"})}).catch(c=>{e({text:c.message,status:"warning"})})},[r,t.orderCancelled]),{confirmOrderCancellation:s}},Se=({slots:r,orderData:t,className:s,statusTitle:e,status:d,routeCreateReturn:o})=>{const{orderStatus:n,order:c}=z({orderData:t}),[u,m]=P(!1),p=()=>{m(!0);const l=new URL(window.location.href),S=l.searchParams.get("orderId"),g=l.searchParams.get("confirmationKey");S&&g&&(l.searchParams.delete("orderId"),l.searchParams.delete("confirmationKey"),window.history.replaceState({},document.title,l.toString()))},f=O({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),C=q(),{confirmOrderCancellation:a}=Y({enableOrderCancellation:C==null?void 0:C.orderCancellationEnabled});return y("div",{className:R(["order-order-status",s]),children:[!u&&(a==null?void 0:a.status)!==void 0&&i(L,{heading:f.cancelOrder,onDismiss:p,description:a.text,type:a.status}),c?i(B,{title:e,status:d||n,slots:r,orderData:c,routeCreateReturn:o}):i(V,{withCard:!1})]})};export{Se as OrderStatus,Se as default};

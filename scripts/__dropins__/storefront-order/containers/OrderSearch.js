import{jsxs as V,jsx as s}from"@dropins/tools/preact-jsx-runtime.js";import{classes as L}from"@dropins/tools/lib.js";import{Card as M,InLineAlert as k,Icon as C,Button as q}from"@dropins/tools/components.js";import{F as D}from"../chunks/OrderCancel.js";import{useState as v,useCallback as w,useEffect as F,useMemo as U}from"@dropins/tools/preact-hooks.js";import{events as _}from"@dropins/tools/event-bus.js";import"@dropins/tools/preact.js";import*as N from"@dropins/tools/preact-compat.js";import{Text as g,useText as H}from"@dropins/tools/i18n.js";import{F as T,g as B}from"../chunks/getFormValues.js";import{r as f}from"../chunks/redirectTo.js";import{g as E,a as z}from"../chunks/getCustomer.js";import"../chunks/network-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/getGuestOrder.graphql.js";import"../chunks/transform-order-details.js";import"../chunks/convertCase.js";const P=r=>N.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...r},N.createElement("path",{vectorEffect:"non-scaling-stroke",fillRule:"evenodd",clipRule:"evenodd",d:"M1 20.8953L12.1922 1.5L23.395 20.8953H1ZM13.0278 13.9638L13.25 10.0377V9H11.25V10.0377L11.4722 13.9638H13.0278ZM11.2994 16V17.7509H13.2253V16H11.2994Z",fill:"currentColor"})),X=({onSubmit:r,loading:t,inLineAlert:a,fieldsConfig:i})=>V(M,{variant:"secondary",className:"order-order-search-form",children:[s("h2",{className:"order-order-search-form__title",children:s(g,{id:"Order.OrderSearchForm.title"})}),s("p",{children:s(g,{id:"Order.OrderSearchForm.description"})}),a.text?s(k,{"data-testid":"orderAlert",className:"order-order-search-form__alert",type:a.type,variant:"secondary",heading:a.text,icon:s(C,{source:P})}):null,s(D,{className:"order-order-search-form__wrapper",name:"orderSearchForm",loading:t,fieldsConfig:i,onSubmit:r,children:s("div",{className:"order-order-search-form__button-container",children:s(q,{className:"order-order-search-form__button",size:"medium",variant:"primary",type:"submit",disabled:t,children:s(g,{id:"Order.OrderSearchForm.button"})},"logIn")})})]}),x=r=>{try{return new URL(window.location.href).searchParams.get(r)}catch{return null}},Z=({onError:r,isAuth:t,renderSignIn:a,routeCustomerOrder:i,routeGuestOrder:m})=>{const[y,u]=v({text:"",type:"success"}),[b,p]=v(!1),c=H({invalidSearch:"Order.Errors.invalidSearch",email:"Order.OrderSearchForm.email",postcode:"Order.OrderSearchForm.postcode",number:"Order.OrderSearchForm.orderNumber"}),R=w(async e=>{const o=x("orderRef"),l=o&&o.length>20;if(!e&&!o||!(e!=null&&e.number)&&!(e!=null&&e.token)&&!o)return null;if(t){const d=await E();(d==null?void 0:d.email)===e.email?f(i,{orderRef:e==null?void 0:e.number}):l||f(m,{orderRef:e.token})}else l||f(m,{orderRef:e==null?void 0:e.token})},[t,i,m]);F(()=>{const e=_.on("order/data",o=>{R(o)},{eager:!0});return()=>{e==null||e.off()}},[R]),F(()=>{const e=x("orderRef"),o=e&&e.length>20?e:null;e&&(o?f(m,{orderRef:e}):t?f(i,{orderRef:e}):a==null||a({render:!0,formValues:{number:e}}))},[t,i,m,a]);const O=U(()=>[{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.email,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:1,name:"email",id:"email",code:"email"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.postcode,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:2,name:"postcode",id:"postcode",code:"postcode"},{entityType:"CUSTOMER_ADDRESS",is_unique:!1,label:c.number,options:[],defaultValue:"",fieldType:T.TEXT,className:"",required:!0,orderNumber:3,name:"number",id:"number",code:"number"}],[c]);return{onSubmit:w(async(e,o)=>{if(!o)return null;p(!0);const l=B(e.target);await z(l).then(n=>{n||u({text:c.invalidSearch,type:"warning"}),_.emit("order/data",n)}).catch(async n=>{var S;let d=!0;r==null||r({error:n.message});const h=t?await E():{email:""};(h==null?void 0:h.email)===(l==null?void 0:l.email)?f(i,{orderRef:l.number}):d=a==null?void 0:a({render:h===null||((S=n==null?void 0:n.message)==null?void 0:S.includes("Please login to view the order.")),formValues:l}),d&&u({text:n.message,type:"warning"})}).finally(()=>{p(!1)})},[t,r,a,i,c.invalidSearch]),inLineAlert:y,loading:b,normalizeFieldsConfig:O}},ce=({className:r,isAuth:t,renderSignIn:a,routeCustomerOrder:i,routeGuestOrder:m,onError:y})=>{const{onSubmit:u,loading:b,inLineAlert:p,normalizeFieldsConfig:c}=Z({onError:y,isAuth:t,renderSignIn:a,routeCustomerOrder:i,routeGuestOrder:m});return s("div",{className:L(["order-order-search",r]),children:s(X,{onSubmit:u,loading:b,inLineAlert:p,fieldsConfig:c})})};export{ce as OrderSearch,ce as default};

import{jsx as m,Fragment as me,jsxs as te}from"@dropins/tools/preact-jsx-runtime.js";import{events as re}from"@dropins/tools/event-bus.js";import{A as x,x as y,q as ne,V as k,o as ge,y as fe,t as he,p as pe}from"./fixtures.js";import{b as X,a as p,A as N,e as Fe,D as O,g as ve,M as J,c as K}from"./getMultilineValues.js";import{classes as Y,getFormErrors as Ie}from"@dropins/tools/lib.js";import{useState as G,useCallback as P,useEffect as z,useRef as Ee,useMemo as Ae}from"@dropins/tools/preact-hooks.js";import{Text as Ce,useText as Se}from"@dropins/tools/i18n.js";import{Field as H,Input as se,Picker as be,Skeleton as $e,SkeletonRow as $}from"@dropins/tools/components.js";/* empty css                      *//* empty css           */import{forwardRef as Me,useRef as Re,useImperativeHandle as Le,useState as U,useEffect as q}from"@dropins/tools/preact-compat.js";const Z={firstname:"given-name",lastname:"family-name",company:"organization",country:"country",region:"address-level1",city:"address-level2",postcode:"postal-code",telephone:"tel",street:"address-line1",email:"email",middlename:"additional-name",prefix:"honorific-prefix",suffix:"honorific-suffix"};function ae(e){return Object.keys(e).length===0&&e.constructor===Object}const we=e=>e.map(t=>{var n;const r=((n=t==null?void 0:t.id)==null?void 0:n.toString())||t.code;return{text:t.name,value:r}}),Ne=e=>e?e.map(t=>({text:t.label,value:t.value})):[];function ye({address:e,addressType:t,availableCountries:r,availableRegions:n,config:s,dismissError:o,errors:c,fields:u,onBlur:d,onChange:F,onInvalid:a,onSelection:h,setAddress:v}){const I=()=>{v(i=>({...i,[p.Region]:"",[p.RegionId]:""})),o(p.Region)},A=i=>{v(M=>({...M,[p.RegionId]:i}))};return u.map(i=>{var f;let M,g=i.frontendInput,b=h,R=F,L=i.isDisabled,D=i.isRequired,w=[],S;return g===x.Multiline?(S=X(i.code,e),M=X(i.code,c)):(S=e[i.code],M=c[i.code]||""),i.code===p.Country&&(w=Ne(r),t===N.SHIPPING&&(y.value.country=S,b=l=>{const E=l.target,{value:C}=E;C&&T({country_code:C}),h(l),I()})),i.code===p.RegionId&&t===N.SHIPPING&&(y.value.selectedRegionId=S),i.code===p.Region&&(t===y.value.addressType&&(L=y.value.pending),D=s.countriesWithRequiredRegion.includes(e==null?void 0:e.country_id),w=we(n),!D&&!s.displayStateIfOptional&&(g=x.Undefined),g=w.length>0?x.Select:x.Text,g===x.Select?t===N.SHIPPING?(y.value.selectedRegion=S,b=l=>{const C=l.target.value;T({country_code:y.value.country,region_id:C}),h(l),A(C)}):b=l=>{h(l);const C=l.target.value;A(C)}:g===x.Text&&t===N.SHIPPING&&(y.value.selectedRegion=S,R=l=>{const E=l.target,{value:C}=E;y.value.country&&T({country_code:y.value.country,region_name:C}),F(l)}),S=w.length>0?((f=w.find(l=>l.value===S))==null?void 0:f.value)||"":S),i.code===p.PostCode&&(D=!s.countriesWithOptionalZipCode.includes(e==null?void 0:e.country_id)),{...i,error:M,frontendInput:g,handleSelect:b,isDisabled:L,isRequired:D,onBlur:d,onChange:R,onInvalid:a,options:w,value:S}})}let Q;function T(e){var o;const t=ne.value.data,r=!!t,n=(o=t==null?void 0:t.shippingAddresses)==null?void 0:o[0],s=n==null?void 0:n.availableShippingMethods;r&&!s&&(clearTimeout(Q),Q=setTimeout(()=>{Fe({criteria:e})},O))}const V=({addressType:e,code:t,index:r})=>r?`${e}-${t}-${r}`:`${e}-${t}`,B=e=>`checkout-address-form__${e}`,ke=({addressType:e,element:t})=>{const{code:r,value:n,defaultValue:s}=t;return m("input",{className:B(r),id:V({addressType:e,code:r}),name:r,type:"hidden",value:n||s},r)},De=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:s,label:o,onBlur:c,onChange:u,onInvalid:d,validateRules:F,value:a}=t,h=oe(F);return m(H,{disabled:s,error:n,children:m(se,{"aria-label":o,autocomplete:Z[r]||"off",className:B(r),floatingLabel:`${o} ${t.isRequired?"*":""}`,id:V({addressType:e,code:r}),onBlur:c,onChange:u,onInvalid:d,placeholder:o,required:t.isRequired||!1,type:"text",name:r,value:a??void 0,...h})})},_e=({addressType:e,element:t})=>{const{code:r,error:n,isDisabled:s,isRequired:o,label:c,multilineCount:u,onBlur:d,onChange:F,onInvalid:a,validateRules:h,value:v}=t,I=u??0,A=oe(h);return m(me,{children:Array.from(Array(I).keys()).map(i=>m(H,{disabled:s,error:(n==null?void 0:n[i])||"",className:"dropin-field--multiline",children:m(se,{id:V({addressType:e,code:r,index:i}),className:B(r),floatingLabel:`${c} ${i!=0?i:""} ${o&&i===0?"*":""}`,autocomplete:i===0?Z[r]:"off","aria-label":c,placeholder:`${c} ${i!=0?i:""}`,type:"text",required:o&&i===0,onChange:F,onBlur:d,onInvalid:a,name:`${r}-${i}`,value:(v==null?void 0:v[i])||void 0,...A})},`${r}-${i}`))})},xe=({addressType:e,element:t})=>{const{code:r,error:n,handleSelect:s,isDisabled:o,isRequired:c,label:u,onBlur:d,onInvalid:F,options:a,value:h}=t,v=s?{handleSelect:s}:{};return m(H,{disabled:o,error:n,children:m(be,{id:V({addressType:e,code:r}),className:B(r),name:r,floatingLabel:`${u} ${c?"*":""}`,required:c,placeholder:u,"aria-label":u,options:a,value:h,autocomplete:Z[r]||"off",onBlur:d,onInvalid:F,...v},r)})},ze=({addressType:e,element:t})=>{switch(t.frontendInput){case"BOOLEAN":case"DATE":case"DATETIME":case"FILE":case"GALLERY":case"IMAGE":case"MEDIA_IMAGE":case"MULTISELECT":case"PRICE":case"TEXTAREA":case"UNDEFINED":case"WEIGHT":return null;case"HIDDEN":return ke({addressType:e,element:t});case"TEXT":return De({addressType:e,element:t});case"MULTILINE":return _e({addressType:e,element:t});case"SELECT":return xe({addressType:e,element:t});default:return null}},oe=e=>e?e.reduce((t,r)=>{switch(r.name){case k.DateRangeMax:return{...t,max:r.value};case k.DateRangeMin:return{...t,min:r.value};case k.FileExtensions:return{...t,accept:r.value};case k.InputValidation:return{...t,pattern:Pe(r.value)};case k.MaxFileSize:case k.MaxImageHeight:case k.MaxImageWidth:return t;case k.MaxTextLength:return{...t,maxLength:r.value};case k.MinTextLength:return{...t,minLength:r.value};default:throw new Error(`Unknown rule: ${r.name}`)}},{}):{},_={alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"alphanumeric-w-space":/^[a-zA-Z0-9 ]+$/,"alphanum-with-spaces":/^[a-zA-Z0-9 ]+$/,email:/^([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9,!#$%&'*+/=?^_`{|}~-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*@([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z0-9-]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*\.(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]){2,})$/i,numeric:/^[0-9]+$/,url:/^((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=+$,\w]+@)?[A-Za-z0-9.-]+|(?:www\.|[-;:&=+$,\w]+@)[A-Za-z0-9.-]+)((?:\/[+~%/.\w\-_]*)?\??(?:[-+=&;%@.\w_]*)#?(?:[.!/\\\w]*))?)$/},Pe=e=>{switch(e){case"alpha":return _.alpha.source;case"alphanumeric":return _.alphanumeric.source;case"alphanumeric-w-space":return _["alphanumeric-w-space"].source;case"alphanum-with-spaces":return _["alphanum-with-spaces"].source;case"url":return _.url.source;case"numeric":return _.numeric.source;case"email":return _.email.source;default:throw new Error(`Unknown validation type: ${e}`)}},Oe=e=>te($e,{...e,children:[m($,{variant:"heading",size:"medium"}),m($,{variant:"empty",size:"medium"}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large",fullWidth:!0}),m($,{size:"large",fullWidth:!0,lines:3}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large"}),m($,{size:"large"})]}),Ve=({addressType:e,className:t,fields:r,formRef:n,headingId:s,name:o,...c})=>te("div",{...c,className:Y(["checkout-fields-form",t]),children:[m(at,{level:2,children:m(Ce,{id:s}),className:"checkout-fields-form__title"}),m("form",{name:o,ref:n,className:Y(["checkout-fields-form__form",t]),noValidate:!0,children:r.sort((u,d)=>!u.sortOrder||!d.sortOrder?u.code<d.code?-1:1:u.sortOrder-d.sortOrder).map(u=>ze({element:u,addressType:e}))})]}),Be=e=>{const t=new FormData(e),r=Object.fromEntries(t);return Object.entries(r).reduce((s,[o])=>{const c=e.elements[o];return c!=null&&c.validationMessage?{...s,[o]:c.validationMessage}:{...s}},{})};function Te(e){const[t,r]=U({});return q(()=>{e&&r(n=>({...n,country_id:e}))},[e]),{defaultValues:t}}function Ge({country:e,addressType:t}){const[r,n]=U([]);return q(()=>{if(!e){n([]);return}ve(e,t).then(s=>{n(s||[])}).catch(s=>{console.error(s)})},[n,e,t]),{availableRegions:r}}function He({autoFill:e,addressType:t,dismissError:r,loadAutoFill:n}){const[s,o]=U(!1),c=pe.value.data,u=!!c,d=ne.value.data,F=!!d;q(()=>{var M;if(!e||!F||s)return;let a,h=!1;a=st({addressType:t,cart:d}),!a&&u&&(a=nt({addressType:t,customer:c}),h=!0);const v=g=>g?g.split(K).length>1:!1;if(!a)return;o(!0);const I={[p.City]:a.city,[p.Company]:a.company||"",[p.Country]:a.country.value,[p.FirstName]:a.firstName,[p.LastName]:a.lastName,[p.PostCode]:a.postCode||"",[p.Telephone]:a.telephone||"",[p.Vat]:a.vatId||""},A=a.region;if(A){const g=(M=A==null?void 0:A.id)==null?void 0:M.toString();g?(I[p.Region]=g,I[p.RegionId]=g):I[p.Region]=A.code}a!=null&&a.street&&a.street.length>0&&a.street.forEach((g,b)=>{I[`${p.Street}${J}${b}`]=g}),((a==null?void 0:a.customAttributes)||[]).forEach(g=>{v(g.code)?g.value.split(K).forEach((R,L)=>{I[`${g.code}${J}${L}`]=R}):I[g.code]=g.value}),n({values:I,triggerAutoSave:h})},[t,e,d,c,s,F,u,n,r])}const vt=Me(({addressType:e,autoFill:t=!0,children:r,headingId:n,name:s,preselectedFields:o,saveAddressHandler:c,onCheckoutDataUpdate:u,...d},F)=>{const{data:a,pending:h}=ge.value,v=fe.value.data,I=v===void 0,A=a===void 0||h,i=he.value.data,M=i===void 0,{defaultValues:g}=Te(i==null?void 0:i.defaultCountry),b=rt({fields:a,preselectedFields:o}),R=Re(null),{address:L,errors:D,loadAutoFill:w,onBlur:S,dismissError:f,onChange:l,onInvalid:E,onSelection:C,setAddress:ie}=et({defaultValues:g,formRef:R,onCheckoutDataUpdate:u,preselection:b,saveAddressHandler:c,type:e}),{availableRegions:ce}=Ge({country:L.country_id,addressType:e});if(Le(F,()=>({triggerSaveAddress:le=>{if(!R.current)return;const de=Be(R.current);if(ae(de))return c({signal:le,address:L})}})),He({addressType:e,autoFill:t,loadAutoFill:w,dismissError:f}),A||I||M)return m(Oe,{"data-testid":`${e}-skeleton`});const ue=ye({address:L,addressType:e,availableCountries:v,availableRegions:ce,config:i,dismissError:f,errors:D,fields:a,onBlur:S,onChange:l,onInvalid:E,onSelection:C,setAddress:ie}),W={[N.SHIPPING]:"shipping",[N.BILLING]:"billing"};return m(Ve,{...d,name:s,addressType:e,className:`checkout-${W[e]}-form`,"data-testid":`${W[e]}-form`,fields:ue,formRef:R,headingId:n})}),Ue="DROPIN__CHECKOUT",j=e=>`${Ue}__${e.toUpperCase()}`,qe=(e,t)=>{window.localStorage.setItem(j(e),JSON.stringify(t))},Ze=e=>{const t=window.localStorage.getItem(j(e));return t?JSON.parse(t):null},je=e=>{window.localStorage.removeItem(j(e))};function We(e){const[t,r]=G(null),n=P(o=>setTimeout(()=>{qe(e,o)},O),[e]),s=P(()=>{je(e)},[e]);return z(()=>{const o=Ze(e);o&&r(o)},[e]),z(()=>{const o=re.on("checkout/order",()=>{s()});return()=>{o==null||o.off()}},[s]),{addressBackup:t,backupAddress:n,removeAddressBackup:s}}const Xe={[N.BILLING]:"billing",[N.SHIPPING]:"shipping"};function Je({address:e,type:t,isValid:r}){z(()=>{const n=setTimeout(()=>{re.emit("checkout/address",{type:Xe[t],address:e,isValid:r()})},O);return()=>{clearTimeout(n)}},[e,r,t])}const Ke={badInput:"aria-label",patternMismatch:"aria-label",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength",tooShort:"minlength",typeMismatch:"aria-label",valueMissing:"aria-label"},Ye=["badInput","patternMismatch","rangeOverflow","rangeUnderflow","tooLong","tooShort","typeMismatch","valueMissing"],Qe=e=>{const[t,r]=G({}),n=P(c=>{const{name:u,validity:d,validationMessage:F}=c;let a=d.valid?"":F;Ye.forEach(h=>{if(!d[h])return;const v=e[h];if(!v)return;const I=Ke[h];a=v.replace("{field}",c.getAttribute(I)||"")}),r(h=>({...h,[u]:a}))},[e]);return{errors:t,dismissError:c=>{t[c]&&r(u=>{const{[c]:d,...F}=u;return F})},validateFormElement:n,resetErrors:()=>{r({})}}},ee=e=>{const t=e.current;if(!t)return!1;const r=Ie(t);return ae(r)},et=({defaultValues:e={},formRef:t,onCheckoutDataUpdate:r,preselection:n={},saveAddressHandler:s,type:o})=>{const c=Se({badInput:"Checkout.AddressForm.Validity.badInput",patternMismatch:"Checkout.AddressForm.Validity.patternMismatch",rangeUnderflow:"Checkout.AddressForm.Validity.rangeUnderflow",tooLong:"Checkout.AddressForm.Validity.tooLong",tooShort:"Checkout.AddressForm.Validity.tooShort",typeMismatch:"Checkout.AddressForm.Validity.typeMismatch",valueMissing:"Checkout.AddressForm.Validity.valueMissing"}),u=Ee(!1),[d,F]=G({});Je({address:d,type:o,isValid:P(()=>ee(t),[t])});const{addressBackup:a,backupAddress:h,removeAddressBackup:v}=We(o),{errors:I,validateFormElement:A,dismissError:i,resetErrors:M}=Qe(c),g=P(f=>{u.current=!1,s(f).then(()=>{v(),r==null||r()}).catch(l=>{u.current=!0,console.error("Saving address form failed:",l)})},[v,s,r]),b=(f,l)=>{F(E=>({...E,[f]:l})),u.current=!0},R=({values:f,triggerAutoSave:l=!1})=>{M(),F(E=>({...E,...f})),l&&(u.current=!0)},L=f=>{const l=f.target,{name:E,value:C}=l;b(E,C),A(l)},D=f=>{const l=f.target;A(l)},w=f=>{const l=f.target,{name:E,value:C}=l;b(E,C),A(l)},S=f=>{f.target.checkValidity()};return z(()=>{F(f=>({...e,...n,...a,...f}))},[e,n,a]),z(()=>{if(!u.current)return;const f=h(d);return()=>{clearTimeout(f)}},[d,h]),z(()=>{if(!u.current||!ee(t))return;const f=new AbortController,l=f.signal,E=setTimeout(()=>{g({signal:l,address:d})},O);return()=>{clearTimeout(E),f.abort()}},[d,t,g]),{address:d,errors:I,loadAutoFill:R,dismissError:i,onChange:L,onSelection:w,onBlur:S,onInvalid:D,setAddress:F}},tt={countryCode:p.Country,region:p.Region,postCode:p.PostCode};function rt({fields:e,preselectedFields:t}){return Ae(()=>!(!!e&&e.length>0)||!!!t?{}:Object.keys(t).reduce((s,o)=>{const c=tt[o];return!c||!e.some(d=>d.code===c)?s:{...s,[c]:t[o]}},{}),[e,t])}const nt=({addressType:e,customer:t})=>e===N.BILLING?t.defaultBillingAddress:t.defaultShippingAddress,st=({addressType:e,cart:t})=>{if(e===N.BILLING)return t.billingAddress;const r=t.shippingAddresses;if(!(!r||r.length===0))return r[0]},at=({className:e,children:t,level:r=2})=>{const n=r>=1&&r<=6?`h${r}`:"h2";return m(n,{className:e,children:t})};export{vt as A,at as H,_ as p};

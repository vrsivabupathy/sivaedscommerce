/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as o,jsxs as _}from"@dropins/tools/preact-jsx-runtime.js";import*as n from"@dropins/tools/preact-compat.js";import{useRef as B,useState as E,useEffect as A}from"@dropins/tools/preact-compat.js";import{classes as c,VComponent as w,getFormValues as P}from"@dropins/tools/lib.js";/* empty css               */import{Accordion as I,AccordionSection as M,Button as k,Icon as b,Input as R}from"@dropins/tools/components.js";import{S as T}from"../chunks/Coupon.js";import{useText as N}from"@dropins/tools/i18n.js";import"../chunks/resetCart.js";import{events as j}from"@dropins/tools/event-bus.js";import{a as L,A as x}from"../chunks/applyCouponsToCart.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/persisted-data.js";import"../chunks/getStoreConfig.js";import"../fragments.js";const z=a=>n.createElement("svg",{id:"Icon_Add_Base","data-name":"Icon \\u2013 Add \\u2013 Base",xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",...a},n.createElement("g",{id:"Large"},n.createElement("rect",{id:"Placement_area","data-name":"Placement area",width:24,height:24,fill:"#fff",opacity:0}),n.createElement("g",{id:"Add_icon","data-name":"Add icon",transform:"translate(9.734 9.737)"},n.createElement("line",{vectorEffect:"non-scaling-stroke",id:"Line_579","data-name":"Line 579",y2:12.7,transform:"translate(2.216 -4.087)",fill:"none",stroke:"currentColor"}),n.createElement("line",{vectorEffect:"non-scaling-stroke",id:"Line_580","data-name":"Line 580",x2:12.7,transform:"translate(-4.079 2.263)",fill:"none",stroke:"currentColor"})))),q=a=>n.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},n.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M18.3599 5.64001L5.62988 18.37",stroke:"currentColor"}),n.createElement("path",{vectorEffect:"non-scaling-stroke",d:"M18.3599 18.37L5.62988 5.64001",stroke:"currentColor"})),D=a=>n.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...a},n.createElement("path",{d:"M17.3332 11.75H6.6665",strokeWidth:1.5,strokeLinecap:"square",strokeLinejoin:"round",vectorEffect:"non-scaling-stroke",fill:"none",stroke:"currentColor"})),V=({className:a,children:y,couponCodeField:f,applyCouponsButton:d,appliedCoupons:p,error:h,onApplyCoupon:l,...u})=>{const r=B(null),g=N({couponTitle:"Cart.PriceSummary.coupon.title"}),C=v=>{var t;v.preventDefault();const S=P(r.current);l==null||l(S);const e=(t=r==null?void 0:r.current)==null?void 0:t.querySelector("input");e&&(e.value="")};return o("div",{...u,"data-testid":"cart-coupons",className:c(["cart-coupons",a]),children:o(I,{"data-testid":"coupon-code",className:c(["cart-coupons__accordion"]),actionIconPosition:"right",iconOpen:z,iconClose:D,children:_(M,{title:g.couponTitle,iconLeft:T,showIconLeft:!0,renderContentWhenClosed:!1,"data-testid":"coupon-code-accordion-section",className:c(["cart-coupons__accordion-section"]),children:[o("form",{"data-testid":"coupon-code-form",className:c(["coupon-code-form--edit"]),ref:r,children:_("div",{className:c(["coupon-code-form__action"]),children:[f&&o(w,{node:f,className:c(["coupon-code-form__codes"])}),d&&o(w,{node:d,className:c(["coupon-code-form--button"]),onClick:C,type:"submit"})]})}),h&&o(w,{node:h,className:c(["coupon-code-form__error"])}),p&&o(w,{node:p,className:c(["coupon-code-form__applied"])})]})})})},oe=({children:a,...y})=>{const[f,d]=E(new Set),[p,h]=E([]),[l,u]=E(new Set),r=N({applyButton:"Cart.PriceSummary.coupon.applyAction",placeholder:"Cart.PriceSummary.coupon.placeholder"}),g=async e=>{const t=e.coupon,s=new Set(f);s.add(t),u(new Set);const i=Array.from(s);L(i,x.REPLACE).then(m=>{if(m===null)throw new Error("Error adding coupon code");d(s)}).catch(m=>{console.warn(m),u(new Set([m.message]))})},C=e=>{const t=new Set(f);t.delete(e),u(new Set);const s=Array.from(t);L(s,x.REPLACE).then(i=>{if(i===null)throw new Error("Error removing coupon code");d(t)}).catch(i=>{console.warn(i),u(new Set([i.message]))})};A(()=>{const e=j.on("cart/data",t=>{const s=t==null?void 0:t.appliedCoupons;if(!s){h([]);return}const i=s.map(m=>m.code);h(i)},{eager:!0});return()=>{e==null||e.off()}},[]),A(()=>{d(new Set(p))},[p]);const v=p.map(e=>o(k,{variant:"tertiary",icon:o(b,{source:q,size:"24"}),onClick:()=>C(e),children:e},e)),S=l.size>0?o("div",{"data-testid":"coupon-code-error",children:Array.from(l)[0]}):void 0;return o(V,{...y,couponCodeField:o(R,{"aria-label":r.placeholder,type:"text",placeholder:r.placeholder,name:"coupon",variant:"primary",value:"","data-testid":"coupon-code-input",maxLength:50,error:l.size>0}),applyCouponsButton:o(k,{variant:"secondary",children:r.applyButton}),error:S,appliedCoupons:o("div",{children:v}),onApplyCoupon:g})};export{oe as Coupons,oe as default};
